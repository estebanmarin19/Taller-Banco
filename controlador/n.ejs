const connection=require('../conexion/conexion');
const cnn=connection();
const {render}=require('ejs');
const bcryptjs=require('bcryptjs')
const controller={};


controller.index=(req,res,next)=>{
    res.render('login')
    res.render("error de controlador");
}


controller.consultageneral=(req,res,next)=>{
    cnn.query('SELECT * FROM usuarios',(err,resbd)=>{
        if(err){
            next(new Error(err))
            console.log("Error en la consulta")
        }
        else{
            console.log(resbd)
            res.render('F_Usuarios',{datos:resbd});
        }
    })
}
controller.insertar=async(req,res,next)=>{
const d=req.body.doccli;
const u=req.body.nomusu;
const c=req.body.clave;
const r=req.body.rol;
const e=req.body.estado;
const i=req.body.imagen;

const password=await bcryptjs.hash(c,8);

console.log(d,u)
cnn.query('INSERT INTO usuarios SET?',{doccli:d,nomusu:u,clave:password,rol:r,estado:e,imagen:i},(err,resbd)=>{
if(err){
    next(new Error(err))
}
else{
res.redirect('/')   
}
});
}

controller.login=async(req,res,next)=>{
    const usu=await req.body.usuario;
    const cla=await req.body.login;
    cnn.query('SELECT * FROM  usuarios WHERE nomusu=?',[usu],async(err,results)=>{
        if(err){
            next(new Error("Error de consulta login",err));
        }
        if(results!=0){
            console.log("primer if")
            if(await(bcryptjs.compare(cla,results[0].clave))){

                console.log("Datos correctos")
            //res.redirect('F_Usuarios')
            rol=results[0].rol;
            uss=results[0].nomusu;
            req.session.login=true;
            switch(rol){

                case 'cliente':
                    res.redirect('Cliente');
                break;

                case 'empleado':
                    res.redirect('F_Usuarios');
                break;

            }
        


        }
        else{
            console.log("Datos Incorrectos");
            res.redirect('/');


        }

        }


            
    })
}

controller.cliente=(req,res,next)=>{
    console.log("En la vista del usuario");
    res.render('Cliente');
}

controller.actualizar=async(req,res,next)=>{
    const docx=req.body.dd;
    const usux=req.body.uu;
    const clax=req.body.cc;
    const rolx=req.body.rr;
    const estx=req.body.ee;
    const imgx=req.body.ii;
    const password=await bcryptjs.hash(clax,8);


    cmm.query('UPDATE usuarios SET nomusu="'+usux+'",clave="'+password+'",rol="'+rolx+'",estado="'+estx+'",imagen="'+imgx+'" WHERE doccli="'+docx+'"',async(err,respbb)=>{
        if(err){
            next(new Error(err));

        }
        else{
            console.log("Actualizado")
            res.redirect('F_Usuarios')
        }




    })
}


module.exports=controller;